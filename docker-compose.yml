version: '3.8'

services:
  # FastAPI Application
  api:
    build:
      context: .
      dockerfile: Dockerfile
      target: runtime
    container_name: helpdesk-api

    # Environment variables - load from .env.local file
    environment:
      # Database (External PostgreSQL with pgvector)
      DB_HOST: ${DB_HOST}
      DB_USER: ${DB_USER}
      DB_PASSWORD: ${DB_PASSWORD}
      DB_NAME: ${DB_NAME}

      # API Configuration
      API_API_KEY: ${API_API_KEY:-dev-api-key-change-in-production-min-32-chars}
      API_WORKERS: ${API_WORKERS:-4}
      API_LOG_LEVEL: ${API_LOG_LEVEL:-info}
      API_POOL_MIN_SIZE: ${API_POOL_MIN_SIZE:-5}
      API_POOL_MAX_SIZE: ${API_POOL_MAX_SIZE:-20}
      API_POOL_TIMEOUT: ${API_POOL_TIMEOUT:-30.0}
      API_HOST: ${API_HOST:-0.0.0.0}
      API_PORT: ${API_PORT:-8000}

      # TDX API Configuration
      TDX_WEBSERVICES_KEY: ${TDX_WEBSERVICES_KEY}
      TDX_BEID: ${TDX_BEID}
      TDX_BASE_URL: ${TDX_BASE_URL:-https://yourdeployment.teamdynamix.com}
      TDX_APP_ID: ${TDX_APP_ID:-2717}

      # Azure OpenAI Embedding Configuration
      EMBEDDING_API_KEY: ${EMBEDDING_API_KEY}
      EMBEDDING_ENDPOINT: ${EMBEDDING_ENDPOINT}
      EMBEDDING_DEPLOYMENT_NAME: ${EMBEDDING_DEPLOYMENT_NAME:-text-embedding-3-large}
      EMBEDDING_API_VERSION: ${EMBEDDING_API_VERSION:-2024-02-01}
      EMBEDDING_EMBED_DIM: ${EMBEDDING_EMBED_DIM:-3072}
      EMBEDDING_MAX_TOKENS: ${EMBEDDING_MAX_TOKENS:-8191}

      # Azure OpenAI Chat Configuration (optional)
      CHAT_API_KEY: ${CHAT_API_KEY}
      CHAT_ENDPOINT: ${CHAT_ENDPOINT}
      CHAT_DEPLOYMENT_NAME: ${CHAT_DEPLOYMENT_NAME:-gpt-4o}
      CHAT_API_VERSION: ${CHAT_API_VERSION:-2024-12-01-preview}
      CHAT_MAX_TOKENS: ${CHAT_MAX_TOKENS:-8191}
      CHAT_TEMPERATURE: ${CHAT_TEMPERATURE:-0.7}
      CHAT_COMPLETION_TOKENS: ${CHAT_COMPLETION_TOKENS:-500}

      # AWS Bedrock Cohere Reranker Configuration
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY}
      AWS_REGION_NAME: ${AWS_REGION_NAME:-us-east-1}
      AWS_RERANKER_ARN: ${AWS_RERANKER_ARN:-cohere.rerank-v3-5:0}

    # Port mapping
    ports:
      - "${API_PORT:-8000}:8000"

    # Volume mounts (optional - for development hot-reload)
    # Uncomment to enable code changes without rebuilding
    # volumes:
    #   - ./api:/app/api
    #   - ./core:/app/core
    #   - ./utils:/app/utils
    #   - ./logs:/app/logs

    # Health check
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health/ready"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

    # Restart policy
    restart: unless-stopped

    # Network mode (default: bridge)
    # For localhost database access on Linux, uncomment:
    # network_mode: host
