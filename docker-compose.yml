services:
  # FastAPI Application
  api:
    build:
      context: .
      dockerfile: Dockerfile
      target: runtime
    container_name: helpdesk-api

    # Environment variables - load from .env file
    environment:
      # Database (External PostgreSQL with pgvector)
      DB_HOST: ${DB_HOST}
      DB_USER: ${DB_USER}
      DB_PASSWORD: ${DB_PASSWORD}
      DB_NAME: ${DB_NAME}

      # API Configuration
      API_API_KEY: ${API_API_KEY:-dev-api-key-change-in-production-min-32-chars}
      API_WORKERS: ${API_WORKERS:-4}
      API_LOG_LEVEL: ${API_LOG_LEVEL:-info}
      API_POOL_MIN_SIZE: ${API_POOL_MIN_SIZE:-5}
      API_POOL_MAX_SIZE: ${API_POOL_MAX_SIZE:-20}
      API_POOL_TIMEOUT: ${API_POOL_TIMEOUT:-30.0}
      API_HOST: ${API_HOST:-0.0.0.0}
      API_PORT: ${API_PORT:-8000}

      # TDX API Configuration
      TDX_WEBSERVICES_KEY: ${TDX_WEBSERVICES_KEY}
      TDX_BEID: ${TDX_BEID}
      TDX_BASE_URL: ${TDX_BASE_URL:-https://yourdeployment.teamdynamix.com}
      TDX_APP_ID: ${TDX_APP_ID:-2717}

      # LiteLLM Proxy Configuration
      LITELLM_PROXY_BASE_URL: ${LITELLM_PROXY_BASE_URL}
      LITELLM_PROXY_API_KEY: ${LITELLM_PROXY_API_KEY}
      LITELLM_EMBEDDING_MODEL: ${LITELLM_EMBEDDING_MODEL:-text-embedding-large-3}
      LITELLM_CHAT_MODEL: ${LITELLM_CHAT_MODEL:-gpt-5.2-chat}
      LITELLM_RERANKER_MODEL: ${LITELLM_RERANKER_MODEL:-cohere-rerank-v3-5}
      LITELLM_EMBED_DIM: ${LITELLM_EMBED_DIM:-3072}
      LITELLM_EMBED_MAX_TOKENS: ${LITELLM_EMBED_MAX_TOKENS:-8191}
      LITELLM_CHAT_MAX_TOKENS: ${LITELLM_CHAT_MAX_TOKENS:-8191}
      LITELLM_CHAT_COMPLETION_TOKENS: ${LITELLM_CHAT_COMPLETION_TOKENS:-500}
      LITELLM_CHAT_TEMPERATURE: ${LITELLM_CHAT_TEMPERATURE:-0.7}

    # Port mapping
    ports:
      - "${API_PORT:-8000}:8000"

    # Volume mounts (optional - for development hot-reload)
    # Uncomment to enable code changes without rebuilding
    # volumes:
    #   - ./api:/app/api
    #   - ./core:/app/core
    #   - ./utils:/app/utils
    #   - ./logs:/app/logs

    # Health check
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health/ready"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

    # Restart policy
    restart: unless-stopped

    # Network mode (default: bridge)
    # For localhost database access on Linux, uncomment:
    # network_mode: host
